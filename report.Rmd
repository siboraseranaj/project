---
title: "Report"
author: "Sibora Seranaj"
date: "3/21/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```

```{r}
library(survival)
library(survminer)
library(readr)
library(rms)
library(knitr)
library(broom)
library(tidyverse)
library(plotROC)
library(dplyr)
library(nnet)
library(eha)
library(sjPlot)
library(sjlabelled)
library(sjmisc)
library(ggplot2)
library(pscl)
library(GLMMadaptive)
library(foreign)
library(MASS)
library(Hmisc)
library(reshape2)
library(brant)
```

```{r}
objective1 <- read_csv("STA440- Project/HEPorASP.csv")
```

```{r}
objective1$strokesubtype <- relevel(as.factor(objective1$strokesubtype), ref = "PACS")
objective1$concious <- relevel(as.factor(objective1$concious), ref = "F")
```
```{r}
surv_object <- Surv(time = objective1$timedeath, event = objective1$death)
```

```{r}
fit1 <- survfit(surv_object ~ 1, data = objective1)
```

```{r}
fit2 <- survfit(surv_object ~ trt, data = objective1)
```

```{r}
objective2 <- read_csv("STA440- Project/HEP_LorH.csv")
```

```{r}
objective2$strokesubtype <- relevel(as.factor(objective2$strokesubtype), ref = "PACS")
objective2$concious <- relevel(as.factor(objective2$concious), ref = "F")
```

```{r}
surv_object2 <- Surv(time = objective2$timedeath, event = objective2$death)
```
```{r}
fit3 <- survfit(surv_object2 ~ 1, data = objective2)
```

```{r}
fit4 <- survfit(surv_object2 ~ trt_hep, data = objective2)
```


# 1 Introduction

## 1.1 Background

In the United States, 1 in every 6 deaths from cardiovascular disease is due to stroke, and every 4 minutes, someone dies of stroke. Around 87% of all strokes are ischemic strokes, in which blood flow to the brain is blocked. Hemorrhagic strokes occur when a blood vessel ruptures inside the brain. Stroke leads to long-term physical and psychological disability. [1][2]

Patients are at high risk of experiencing another stroke in the first few days after having the initial one. Blood-thinning medications are used to prevent blood from clotting, therefore they may help reduce the risk of a recurrent stroke and death. There are two main types of blood-thinners, anticoagulants and antiplatelet medications. Aspirin is a common antiplatelet drug which prevents platelets from coming together to form a clot. Heparin is an anticoagulant which slows the process of making clots in the body. Both these medications might reduce the likelihood of experiencing another stroke, but they follow different mechanisms of action, and previous research shows that their comparative effectiveness is not clear. [3][insert lit review]
 
# 1.2 Research Goals

In this research, we intend to explore the comparative effectiveness of early administration of aspirin and heparin by focusing on two objectives: a) the difference in time from diagnosis of the acute stroke until death, and b) the difference in the proportion of patients who experience recurrent strokes. The null hypotheses for these objectives would be that the treatments do not differ after controlling for potential confounders.

(NOTE FOR PROFESSOR: I also want to look at the difference between low dose heparin vs high dose heparin, but I do not know how to word this here professionally)

# 1.3 Data

The data used in this project was modified from the original International Stroke Trial publication by Sandercock et al, who anonymized, formatted the dataset and made it publicly available. [5] IST was a randomized, open label trial that was conducted from 1991 to 1996. Patients were administered aspirin, subcutenous heparin, both, or neither, and then followed throughout the clinical course of their stroke. The treatment was given immediately upon randomization. Assigned heparin dosages were either 5000 IU or 12,500 IU, while aspirin dosages were always 300 mg. Both the physicians and the patients were aware of the treatment assigned. All patients included in the study were clinically diagnosed with acute stroke in the previous 48 hours, and showed no clear indication for neither aspirin or heparin. There was no upper age limit, and the CT scan confirmed the diagnosis of the stroke before randomization. 


# 1.4 Variables

The original dataset contains information on 19,435 patients. The response variables for the objectives are: (a) time-to-death and (b) recurrent stroke. The main predictor variable of interest is the treatment group, and other variables are included to control for their effect on the treatment outcome. Specifically, the predictor variables include age, sex, systolic blood pressure, atrial fibrillation, physical deficit, state of consciousness and stroke subtype. These variables were chosen because provide insight on the state of health of the patients at the time of randomization. 

Most patients presented with a mixture of symptoms (face deficit, leg/foot deficit, hand/arm deficit, dysphasia, hemianopia, visuospatial disorder, brainstem/cerebellar signs), therefore the physical deficit variable was created to indicate the total number of symptoms that the patient experienced. Each symptom was considered present only if the physician had successfully diagnosed it.

Stroke subtype is treated as a categorical variable, with levels: total anterior circulation syndrome (TACS), partial anterior circulation syndrome (PACS), posterior circulation syndrome (POCS) and lacunar syndrome (LACS). The state of consciousness is treated as a categorical variable with three levels: fully conscious, drowsy and unconscious. (Should I even keep this variable)

The treatment variable was created to describe the type of treatment that the patients were assigned. This variable is categorical and has four levels: aspirin (`RXASP = "Y"` and `RHXEP= "N"`), heparin (`RXHEP = "M"` or `"H" and RXASP = "N"`), both (`RXHEP = "M"` or `"H" and RXASP = "Y"`), and none (`RXASP= "N"` and `RHXEP= "N"`). It should be noted that in the original trial the patients were assigned two doses of heparin: high (`heparin = "H"` or `heparin = "M"`, which are the same amount of drug, despite the different encoding in the original study) or low (`heparin = "L"`).

The variables age, systolic blood pressure, and atrial fibrillation are treated as numerical variables. It should be noted that 934 patients who participated in the pilot phase of the trial did not have atrial fibrillation values and were therefore excluded from this study. 

# 1.5 Exploratory Data Analysis
### 1.5.1 Objective 1

We compared the primary outcome of the number of days from the patients' stroke admission date to the date the patient died between the aspirin only and heparin only treatment groups. We chose an intention-to-treat analysis, which means that we included all the patients regardless if they followed the directions for their treatment. Because the reasons for nonadherence to the protocol might be related to the patients' prognosis, the ITT analysis is deemed more appropriate. Previous research has also showed strong indication to using ITT analysis in such cases. [5] 

The Kaplan-Meier curve shows that patients who received aspirin have a higher survival probability than those who received heparin. However it should be noted that the confidence intervals of these curves overlap significantly, especially in the earlier days. 

```{r fig.align='center', fig.height=3.5, fig.width=5.5}
ggsurvplot(fit2, xlab = "Days", ylab = "Est. Event Probability", conf.int = T, censor = F, fun = "event", legend.labs = c("Aspirin", "Heparin"))
```
*Figure 1. Kaplan-Meier estimate of the survival curve in intention-to-treat analysis, Aspirin vs Heparin*

The Kaplan-Meier curves show that patients who received aspirin have a higher survival probability than those who received heparin. However it should be noted that the confidence intervals of these curves overlap, especially in the earlier days. 

### 1.5.2 Objective 2

```{r fig.align='center', fig.height=3.5, fig.width=5.5}
ggsurvplot(fit4, xlab = "Days", ylab = "Est. Event Probability", conf.int = T, censor = F, fun = "event", legend.labs = c("Low Heparin", "High Heparin"))
```
*Figure 2. Kaplan-Meier estimate of the survival curve in intention-to-treat analysis, Low Heparin vs High Heparin* 
\newline The Kaplan-Meier curves show that patients who received low dose heparin have a similar survival probability to those who received high dose heparin. There seems to be no difference in survival between the heparin dosages.

XXXXXX FOR OBJECTIVE THREE ASK PROFESSOR IF REPLACING NAN WITH 180 MAKES SENSE

# 2 Methodology

## 2.1 The Cox Proportional Hazard Model

### 2.1.1 Aspirin vs. Heparin

For this analysis, we focus on patients who were treated with only with aspirin or only with heparin, in order to investigate the difference between the two. The Kaplan-Meier survival curves in subsection 1.5 showed significant overlap, thus the log-rank test is not very powerful in determining if there is a difference in survival rates. Therefore, we decided to fit a survival model, which allows us to control for potential confounders. We decided not to use an Accelerated Failure Time model, because AFT models are fully parametric, and we do not have enough prior knowledge to specify a distribution for the error term. Semiparametric AFT models would be more appropriate in this case, however their use is relatively scarce in applied research. The Cox proportional hazard model is suitable, because it is semiparametric, and we do not have to make assumptions about the distribution of the baseline hazard function. Moreover, the Cox model is widely used in the medical community, which makes it interpretable to other researchers in this field.

The equation of our model is specified below:

$$
\lambda_i(t) = \lambda_0(t) * exp(\beta_1*I(treatment_i = Heparin) +
$$
$$
\beta_2*time\:delay_i + \beta_3*I(atrial\: fibrillation_i = Yes) + \beta_4*I(sex_i = M) + 
$$
$$
\beta_5*I(age) + \beta_6*I(concious_i = Drowsy) + \beta_7*I(concious_i = Unconcious) + \beta_8*I(blood \: pressure_i) +
$$
$$
\beta_9*I(physical\: deficit_i) + \beta_{10}*I(stroke\:subtype_i = LASC) +
$$
$$
\beta_{11}*I(stroke\:subtype_i = POCS) + \beta_{12}*I(stroke\:subtype_i = TACS) 
$$

$$
+ \beta_{12}*I(stroke\:subtype_i = LACS) + \beta_{12}*I(stroke\:subtype_i = Other)
$$
where $i$ describes the i-th patient.

We calculated the Schoenfeld residuals in order to evaluate the proportional hazards assumption, and the deviance residuals in order to asses model assumptions. More details can be found in the Appendix section.

### 2.1.2 Heparin Low-Dose vs. Heparin High-Dose

For this analysis, we focus on patients who were treated with only with aspirin or only with heparin, in order to investigate if dosage plays a role. We decided to fit a Cox model because there was significant overlap in the Kaplan-Meir Curves. Model assumptions can be found in the Appendix.
 

## 2.2 Aspirin vs. Heparin in Recurrent Stroke

We use a binary logistic regression in order to examine the difference in recurrent strokes between the aspirin only and heparin only groups while adjusting for potential confounders. The logistic model is appropriate because of the binary nature of the response variable recurrent stroke (yes or no). Moreover, the logistic regression is relatively easy to interpret. The same set of explanatory variables as in Objective 1 is used. Predictor treatment type is extremely significant in predicting the probability of a patient experiencing a recurrent stroke.

The equation of our model is specified below:
 
$$
logit(p_i) = \beta_0 + \beta_1*I(treatment_i = Aspirin) +
$$
$$
\beta_2*time\:delay_i + \beta_3*I(atrial\: fibrillation_i = Yes) + \beta_4*I(sex_i = F) + 
$$
$$
\beta_5*I(age) + \beta_6*I(concious_i = Drowsy) + \beta_7*I(concious_i = Unconcious) + \beta_8*I(blood \: pressure_i) +
$$
$$
\beta_9*I(physical \:deficit_i = Yes) + \beta_{10}*I(stroke\:subtype_i = LASC) +
$$
$$
\beta_{11}*I(stroke\:subtype_i = PACS) + \beta_{12}*I(stroke\:subtype_i = TACS)
$$
where $i$ describes the i-th patient; $p_i$ describes the probability of the i-th patient experiencing a recurrent stroke within 2 weeks from randomization. 
\newline
The logistic model assumptions such as independent observations, binary response, little to no multicollinearity between predictors, linearity of independent variables and log-odds, and large sample size are evaluated and can be found in the Appendix section.

# 3 Results

### Objective 1

|Term | Exp(Estimate) | Standard Error | P-Value|
|---------------- | ----------------: | ------------------:| :----------------- 
| Treatment: Heparin            |   1.097 | 0.045 | 0.039  *  | 
| Time delay       |    0.998 | 0.0019 | 0.152    |
| Atrial fibrillation |  1.408 | 0.050  | <0.001 ***| 
| Sex: Male  |               1.113 | 0.046  | 0.021 *  | 
| Age  |                1.046 | 0.003 | <0.001 *** | 
| Concious: Drowsy    |       2.582 |  0.052 | <0.001 *** | 
| Concious: Unconcious    |  9.654 |  0.106 |  <0.001 ***
| Infarct    |         1.123 | 0.048  | 0.017  *  | 
| Blood pressure   |    0.998  | 0.001 | 0.012 *  | 
| Stroke subtype: LACS|   0.703 | 0.086 | <0.001 *** | 
| Stroke subtype: Other |    1.805 | 0.504  | 0.241 |    
| Stroke subtype: POCS |  0.991 | 0.083 | 0.9169   |  
| Stroke subtype: TACS  |  1.317 | 0.061  | <0.001 *** | 
| Physical deficit  |    1.152 | 0.022  | <0.001 *** | 

\begin{center}
Output of Cox Proportional Hazard Model with the most significant predictors (* p<0.05, *** p<0.001)
\end{center}

# 4 Discussion

There might be bias because the doctors know the type of drug assigned.

The results from this study may not be generalizable to entire population of stroke patients nowadays, because acute stroke care has changed in the recent years. At the time of this trial, thrombolytic therapy was not widely available, and none of the patients in this dataset patients received it [source]. Thus, the background stroke care for the included patients, might be more reflective of current stroke care in resource poor settings [source]. 

For 2.1 we decided against using a Accelerated Failure Time model, because we do not have enough prior knowledge to appropriately specify a distribution for the error term.

The focus of this analysis is not prediction, because we are only focusing in exploring the difference in the odds of a recurrent stroke. 



# Bibliography

[1] Centers for Disease Control and Prevention. Underlying Cause of Death, 1999–2018. CDC WONDER Online Database. Atlanta, GA: Centers for Disease Control and Prevention; 2018. 

[2] Virani SS, Alonso A, Benjamin EJ, Bittencourt MS, Callaway CW, Carson AP, et al. Heart disease and stroke statistics—2020 update: a report from the American Heart Associationexternal icon. Circulation. 2020;141(9):e139–e596.
[3] https://www.stroke.org/en/life-after-stroke/preventing-another-stroke/anti-clotting-agents-explained

https://www.ncbi.nlm.nih.gov/pmc/articles/PMC81628/

[3] The International Stroke Trial (IST): a randomised trial of aspirin, subcutaneous heparin, both, or neither among 19435 patients with acute ischaemic stroke. International Stroke Trial Collaborative Group. Lancet. 1997 May 31;349(9065):1569-81. PMID: 9174558.

[4] Sandercock, P.A., Niewada, M., Członkowska, A. et al. The International Stroke Trial database. Trials 12, 101 (2011). https://doi.org/10.1186/1745-6215-12-101 

[5] Sandercock, Peter; Niewada, Maciej; Czlonkowska, Anna. (2011). International Stroke Trial database (version 2), [dataset]. University of Edinburgh. Department of Clinical Neurosciences. https://doi.org/10.7488/ds/104

# 5 Appendix

### Objective 1

```{r}
coxm1 <- coxph(surv_object ~ trt  + timedelay + atrialfibrillation + sex + age + concious + infarct + bloodpressure + strokesubtype + physicaldeficit, data = objective1)
```
```{r, fig.align="center"} 
# schoenfeld 
ggcoxdiagnostics(coxm1, type = "schoenfeld")
```
```{r, fig.width = 5, fig.height = 3, fig.align="center"}
# deviance 
ggcoxdiagnostics(coxm1, type = "deviance", linear.predictions = F)
```

Schoenfeld residuals are fairly symmetric around 0. Deviance residuals are also fairly symmetric around 

Independence assumption is also satisfied as the survival times are independent across distinct patients. 

### Objective 2

```{r}
coxm2 <- coxph(surv_object2 ~ trt_hep  + timedelay + atrialfibrillation + sex + age + concious + infarct + bloodpressure + strokesubtype + physicaldeficit, data = objective2)
```

```{r, fig.align="center"} 
ggcoxdiagnostics(coxm2, type = "schoenfeld")
```
```{r, fig.width = 5, fig.height = 3, fig.align="center"}
#deviance 
ggcoxdiagnostics(coxm2, type = "deviance", linear.predictions = F)
```