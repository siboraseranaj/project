---
title: "Report"
author: "Sibora Seranaj"
date: "3/21/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```

```{r}
library(survival)
library(survminer)
library(readr)
library(rms)
library(knitr)
library(broom)
library(tidyverse)
library(plotROC)
library(dplyr)
library(nnet)
library(eha)
library(sjPlot)
library(sjlabelled)
library(sjmisc)
library(ggplot2)
library(pscl)
library(GLMMadaptive)
library(foreign)
library(MASS)
library(Hmisc)
library(reshape2)
library(brant)
```

```{r}
objective1 <- read_csv("STA440- Project/death.csv")
```

```{r}
objective1$strokesubtype <- relevel(as.factor(objective1$strokesubtype), ref = "PACS")
objective1$concious <- relevel(as.factor(objective1$concious), ref = "F")
```
```{r}
surv_object <- Surv(time = objective1$timedeath, event = objective1$death)
```

```{r}
fit1 <- survfit(surv_object ~ 1, data = objective1)
```

```{r}
fit2 <- survfit(surv_object ~ trt, data = objective1)
```

```{r}
objective2 <- read_csv("STA440- Project/death.csv")
```

```{r}
objective2$strokesubtype <- relevel(as.factor(objective2$strokesubtype), ref = "PACS")
objective2$concious <- relevel(as.factor(objective2$concious), ref = "F")
```

```{r}
surv_object2 <- Surv(time = objective2$recurrentstrokedate, event = objective2$recurrentstroke)
```

```{r}
fit3 <- survfit(surv_object2 ~ 1, data = objective2)
```

```{r}
fit4 <- survfit(surv_object2 ~ trt, data = objective2)
```


# 1 Introduction

## 1.1 Background

In the United States, 1 in every 6 deaths from cardiovascular disease is due to stroke, and every 4 minutes, someone dies of stroke. Around 87% of all strokes are ischemic strokes, in which blood flow to the brain is blocked. Hemorrhagic strokes occur when a blood vessel ruptures inside the brain. Stroke leads to long-term physical and psychological disability. [1][2]

Patients are at high risk of experiencing another stroke in the first few days after having the initial one. Blood-thinning medications are used to prevent blood from clotting, therefore they may help reduce the risk of a recurrent stroke and death. There are two main types of blood-thinners, anticoagulants and antiplatelet medications. Aspirin is a common antiplatelet drug which prevents platelets from coming together to form a clot. Heparin is an anticoagulant which slows the process of making clots in the body. Both these medications might reduce the likelihood of experiencing another stroke, but they follow different mechanisms of action, and previous research shows that their comparative effectiveness is not clear. [3][4]
 
## 1.2 Research Goals

In this research, we intend to explore the comparative effectiveness of early administration of aspirin and heparin by focusing on two objectives: a) the difference in time from diagnosis of the acute stroke until death, and b) the difference in time from diagnosis of the acute stroke until a recurrent stroke. The null hypotheses for these objectives would be that the treatments do not differ after controlling for potential confounders.

## 1.3 Data

The data used in this project was modified from the original International Stroke Trial publication by Sandercock et al, who anonymized, formatted the dataset and made it publicly available. [5] IST was a randomized, open label trial that was conducted from 1991 to 1996. Patients were administered aspirin, subcutenous heparin, both, or neither, and then followed throughout the clinical course of their stroke. The treatment was given immediately upon randomization. Assigned heparin dosages were either 5000 IU or 12,500 IU, while aspirin dosages were always 300 mg. Both the physicians and the patients were aware of the treatment assigned. All patients included in the study were clinically diagnosed with acute stroke in the previous 48 hours, and showed no clear indication for neither aspirin or heparin. There was no upper age limit, and the CT scan confirmed the diagnosis of the stroke before randomization. The primary outcomes of the trial were recurrent stroke within 14 days, and death within 6 months of diagnosis.


## 1.4 Variables

The response variables for the objectives are: (a) time-to-death and (b) time-to-recurrent stroke. The main predictor variable of interest is the treatment group, and the other variables are included to control for their effect on the treatment outcome. Across both objectives, the predictor variables include age, sex, systolic blood pressure, atrial fibrillation, time delay from stroke to treatment, physical deficit, state of consciousness and stroke subtype. These variables were chosen because they provide insight on the state of health of the patients at the time of randomization, and because existing literature has indicated a relationship between these variables and stroke fatalities. For example, sex, age, blood pressure and atrial fibrillation are considered critical factors in stroke pathology in previous studies. (https://www.ahajournals.org/doi/full/10.1161/strokeaha.115.009592#:~:text=Lowering%20blood%20pressure%20(BP)%20after,in%20hypertensive%20patients%20is%20unclear.)(https://academic.oup.com/endo/article/159/8/3120/5051605). Moreover, the association between different stroke subtypes and mortality is an active area of research, with several studies suggesting a possible relationship between the two, therefore we deemed it appropriate to include it in our study. Lastly, we believe that the presence of multiple stroke-related physical deficits and the state of consciousness of the patient might be indicators of the severity of the stroke, and the area of brain affected by it, which then might have an effect on recurrent strokes and/or death.

The treatment variable was created to describe the type of treatment that each patient received. This variable is categorical and has two levels: aspirin (`RXASP = "Y"` and `RHXEP= "N"`) and heparin (`RXHEP = "M"` or `"RXHEP = "H"` or `"RXHEP = "L"`, and `RXASP = "N"`). In the original trial, the patients assigned with heparin could receive two different dosages, however three different encodings were mistakenly used to indicate the amount used.

Given that most patients presented with a mixture of physical symptoms (face deficit, leg/foot deficit, hand/arm deficit, dysphasia, hemianopia, visuospatial disorder, brainstem/cerebellar signs), it was deemed appropriate to create the physical deficit variable to indicate the total number of symptoms that the patient experienced. Each symptom was considered present only if a physician had successfully diagnosed it. The physical deficit variable, age, systolic blood pressure, and atrial fibrillation are treated as numerical. The stroke subtype variable is treated as categorical, with five levels: total anterior circulation syndrome (TACS), partial anterior circulation syndrome (PACS), posterior circulation syndrome (POCS), lacunar syndrome (LACS) and other (in the case where the physician could not identify the subtype). Finally, the state of consciousness is treated as a categorical variable with three levels: fully conscious, drowsy and unconscious. 

It should be noted that patients with missing or incomplete trial data in any of the fields mentioned above were excluded from the study. The final dataset used in this study contains information on 9146 patients.


XXX WRITE ABOUT THE STROKE< DEATH AND TIME VARIABLE

## 1.5 Exploratory Data Analysis

For both objectives, we chose an intention-to-treat analysis, which means that the study included all the patients regardless if they followed the directions for their treatment. Because the reasons for nonadherence to the protocol might be related to the patients' prognosis, the ITT analysis is considered more appropriate. Previous research has also showed strong indication to using ITT analysis in such cases. [5] 

WRITE ABOUT THE FAKE CENSORING

### 1.5.1 Objective 1

We compared duration from the patients' stroke admission date to the patient's death date between the aspirin and heparin treatment groups. The Kaplan-Meier curve below shows that patients who received aspirin seem to have a higher survival probability than those who received heparin. However, it should be noted that the confidence intervals of these curves overlap significantly throughout the clinical course, especially in the earlier days, therefore it is not clear whether a this observed relationship is statistically significant.

```{r fig.align='center', fig.height=3.5, fig.width=5.5}
ggsurvplot(fit2, xlab = "Days", ylab = "Est. Event Probability", conf.int = T, censor = F, fun = "event", legend.labs = c("Aspirin", "Heparin"))
```
*Figure 1. Kaplan-Meier estimate of the survival curve in intention-to-treat analysis, Aspirin vs Heparin*


### 1.5.2 Objective 2

We compared duration from the patients' stroke admission date to the patient's recurrent stroke date between the aspirin and heparin treatment groups. The Kaplan-Meier curve below shows that patients who received heparin seem to have a higher probability to experience recurrent strokes than those who received aspirin. Similarly as above, there is significant overlap in the confidence intervals of the Kaplain-Meier curves.

```{r fig.align='center', fig.height=3.5, fig.width=5.5}
ggsurvplot(fit4, xlab = "Days", ylab = "Est. Event Probability", conf.int = T, censor = F, fun = "event", legend.labs = c("Aspirin", "Heparin"))
```
*Figure 2. Kaplan-Meier estimate of the survival curve in intention-to-treat analysis, Aspirin vs Heparin* 


# 2 Methodology

### 2.1 Mortality

The Kaplan-Meier survival curves in subsection 1.5.1 showed significant overlap, thus the log-rank test is not very powerful in determining if there is a difference in risk of death within 6 months of acute stroke. We decided to fit a survival model, which allows us to control for potential confounders. We initially considered a parametric Accelerated Failure Time model. AFT models are fully parametric, and they include an error term which is assumed to follow a specific probability distribution. We do not have enough knowledge to appropriately specify such distribution, so we decided against it. Semiparametric AFT models we also briefly considered, however their use is relatively scarce in applied research.[Buckley, Jonathan; James, Ian (1979), "Linear regression with censored data", Biometrika, 66 (3): 429–436, doi:10.1093/biomet/66.3.429, JSTOR 2335161
, https://onlinelibrary.wiley.com/doi/abs/10.1002/sim.4780111409] We ultimately chose the Cox proportional hazard model, because it is a semiparametric model, and also we do not have to make assumptions about the distribution of the baseline hazard function. Moreover, the Cox proportional hazard model is widely used in the medical community, which makes this analysis interpretable to other researchers in this field.

The equation of our model is specified below:

$$
\lambda_i(t) = \lambda_0(t) * exp(\beta_1*I(treatment_i = Heparin) +
$$
$$
\beta_2*time\:delay_i + \beta_3*I(atrial\: fibrillation_i = Yes) + \beta_4*I(sex_i = M) + 
$$
$$
\beta_5*I(age) + \beta_6*I(concious_i = Drowsy) + \beta_7*I(concious_i = Unconcious) + \beta_8*I(blood \: pressure_i) +
$$
$$
\beta_9*I(physical\: deficit_i) + \beta_{10}*I(stroke\:subtype_i = LASC) +
$$
$$
\beta_{11}*I(stroke\:subtype_i = POCS) + \beta_{12}*I(stroke\:subtype_i = TACS) 
$$

$$
+ \beta_{12}*I(stroke\:subtype_i = LACS) + \beta_{12}*I(stroke\:subtype_i = Other))
$$
where $i$ describes the i-th patient.

We calculated the Schoenfeld residuals in order to evaluate the proportional hazards assumption, and the deviance residuals in order to asses model assumptions. More details can be found in the Appendix section.

### 2.2 Recurrent Stroke

The Kaplan-Meier survival curves in subsection 1.5.2 showed significant overlap, thus using a similar logic as above, we decided to fit a Cox proportional hazard model in order to explore the difference in risk of experiencing a recurrent stroke within 14 days of acute stroke between the two treatment groups, after adjusting for potential confounders.

$$ 
\lambda_i(t) = \lambda_0(t) * exp(\beta_1*I(treatment_i = Heparin) +
$$
$$
\beta_2*time\:delay_i + \beta_3*I(atrial\: fibrillation_i = Yes) + \beta_4*I(sex_i = M) + 
$$
$$
\beta_5*I(age) + \beta_6*I(concious_i = Drowsy) + \beta_7*I(concious_i = Unconcious) + \beta_8*I(blood \: pressure_i) +
$$
$$
\beta_9*I(physical\: deficit_i) + \beta_{10}*I(stroke\:subtype_i = LASC) +
$$
$$
\beta_{11}*I(stroke\:subtype_i = POCS) + \beta_{12}*I(stroke\:subtype_i = TACS) 
$$

$$
+ \beta_{12}*I(stroke\:subtype_i = LACS) + \beta_{12}*I(stroke\:subtype_i = Other))
$$

where $i$ describes the i-th patient

More details regarding proportional hazards and model assumptions can be found in the Appendix section.

# 3 Results

### Objective 1

|Term | Exp(Estimate) | Standard Error | P-Value|
|---------------- | ----------------: | ------------------:| :----------------- 
| Treatment: Heparin            |   1.097 | 0.045 | 0.039  *  | 
| Time delay       |    0.998 | 0.0019 | 0.152    |
| Atrial fibrillation |  1.408 | 0.050  | <0.001 **| 
| Sex: Male  |               1.113 | 0.046  | 0.021 *  | 
| Age  |                1.046 | 0.003 | <0.001 ** | 
| Concious: Drowsy    |       2.582 |  0.052 | <0.001 ** | 
| Concious: Unconcious    |  9.654 |  0.106 |  <0.001 **
| Infarct    |         1.123 | 0.048  | 0.017  *  | 
| Blood pressure   |    0.998  | 0.001 | 0.012 *  | 
| Stroke subtype: LACS|   0.703 | 0.086 | <0.001 ** | 
| Stroke subtype: Other |    1.805 | 0.504  | 0.241 |    
| Stroke subtype: POCS |  0.991 | 0.083 | 0.9169   |  
| Stroke subtype: TACS  |  1.317 | 0.061  | <0.001 ** | 
| Physical deficit  |    1.152 | 0.022  | <0.001 ** | 

\begin{center}
Output of Cox Proportional Hazard Model with the most significant predictors (* p<0.05, ** p<0.001)
\end{center}

### Objective 2


|Term | Exp(Estimate) | Standard Error | P-Value|
|---------------- | ----------------: | ------------------:| :----------------- 
| Treatment: Heparin            |   1.193 | 0.045 | 0.039  *  | 
| Time delay       |    0.989 | 0.0019 | 0.152    |
| Atrial fibrillation |  1.133 | 0.050  | <0.001 **| 
| Sex: Male  |               1.007| 0.046  | 0.021 *  | 
| Age  |                1.003  | 0.003 | <0.001 ** | 
| Concious: Drowsy    |       1.296|  0.052 | <0.001 ** | 
| Concious: Unconcious    |  0.594  |  0.106 |  <0.001 **
| Infarct    |         1.0447  | 0.048  | 0.017  *  | 
| Blood pressure   |    1.002 | 0.001 | 0.012 *  | 
| Stroke subtype: LACS|   0.778955  | 0.086 | <0.001 ** | 
| Stroke subtype: Other |    2.746752  | 0.504  | 0.241 |    
| Stroke subtype: POCS |  1.108234  | 0.083 | 0.9169   |  
| Stroke subtype: TACS  |  0.978518  | 0.061  | <0.001 ** | 
| Physical deficit  |    1.035148  | 0.022  | <0.001 ** |

\begin{center}
Output of Cox Proportional Hazard Model with the most significant predictors (* p<0.05, ** p<0.001)
\end{center}


### Objective 2

# 4 Discussion


The results from this study may not be generalizable to entire population of stroke patients nowadays, because acute stroke care has changed in the recent years. At the time of this trial, thrombolytic therapy was not widely available, and none of the patients in this dataset patients received it [source]. Thus, the background stroke care for the included patients, might be more reflective of current stroke care in resource poor settings [source]. 

The focus of this analysis is not prediction, because we are only focusing in exploring the difference in the odds of a recurrent stroke. 

We can see from the low estimates and high p-values for both that the treatment type is really not a significant predictor for number of adverse events or maximum level of severity 

------- To conclude, we did not find any evidence for differences between the two types of drugs in terms of the adverse event indicators we used. 

Answer is yes but not too much
time to relapse, BUP-NX treatment seem to be better, after removing the patients who did not make it through induction, the two treatments really did not significantly differ  from each other

Induction success, BUP-NX had a higher proportion of patients who made it through induction.

Overall, BUP-NX is better at successfully inducting patients, but once past that, the two don't really differ

There are a few limitations in this study.  one is prediction power relatively weak. While that is not the priority related to our objectives, it could use some improvement in the future. There might be bias because the doctors know the type of drug assigned.

# Bibliography

[1] Centers for Disease Control and Prevention. Underlying Cause of Death, 1999–2018. CDC WONDER Online Database. Atlanta, GA: Centers for Disease Control and Prevention; 2018. 

[2] Virani SS, Alonso A, Benjamin EJ, Bittencourt MS, Callaway CW, Carson AP, et al. Heart disease and stroke statistics—2020 update: a report from the American Heart Associationexternal icon. Circulation. 2020;141(9):e139–e596.
[3] https://www.stroke.org/en/life-after-stroke/preventing-another-stroke/anti-clotting-agents-explained

https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3526137/

https://www.ncbi.nlm.nih.gov/pmc/articles/PMC81628/

[3] The International Stroke Trial (IST): a randomised trial of aspirin, subcutaneous heparin, both, or neither among 19435 patients with acute ischaemic stroke. International Stroke Trial Collaborative Group. Lancet. 1997 May 31;349(9065):1569-81. PMID: 9174558.

[4] Sandercock, P.A., Niewada, M., Członkowska, A. et al. The International Stroke Trial database. Trials 12, 101 (2011). https://doi.org/10.1186/1745-6215-12-101 

[5] Sandercock, Peter; Niewada, Maciej; Czlonkowska, Anna. (2011). International Stroke Trial database (version 2), [dataset]. University of Edinburgh. Department of Clinical Neurosciences. https://doi.org/10.7488/ds/104

# 5 Appendix

### Objective 1

```{r}
coxm1 <- coxph(surv_object ~ trt  + timedelay + atrialfibrillation + sex + age + concious + infarct + bloodpressure + strokesubtype + physicaldeficit, data = objective1)
#summary(coxm1)
```

```{r, fig.align="center"} 
# schoenfeld 
ggcoxdiagnostics(coxm1, type = "schoenfeld")
```
```{r, fig.width = 5, fig.height = 3, fig.align="center"}
# deviance 
ggcoxdiagnostics(coxm1, type = "deviance", linear.predictions = F)
```

Schoenfeld residuals are fairly symmetric around 0. Deviance residuals are also fairly symmetric around 

Independence assumption is also satisfied as the survival times are independent across distinct patients. 

### Objective 2

```{r}
coxm2 <- coxph(surv_object2 ~ trt  + timedelay + atrialfibrillation + sex + age + concious + infarct + bloodpressure + strokesubtype + physicaldeficit, data = objective2)
#summary(coxm2)
```

```{r, fig.align="center"} 
ggcoxdiagnostics(coxm2, type = "schoenfeld")
```
```{r, fig.width = 5, fig.height = 3, fig.align="center"}
#deviance 
ggcoxdiagnostics(coxm2, type = "deviance", linear.predictions = F)
```
